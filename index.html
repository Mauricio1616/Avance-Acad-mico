<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Plataforma Académica</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    { "imports": { "react": "https://esm.sh/react@18.2.0", "react-dom/client": "https://esm.sh/react-dom@18.2.0/client", "lucide-react": "https://esm.sh/lucide-react@0.263.1" } }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { User, Lock, Layout, Plus, Trash2, Save, Edit, Settings, BarChart2, Image as ImageIcon, ArrowLeft, Send, LogOut, RefreshCw, AlertTriangle, CheckCircle, Database } from 'lucide-react';

        // ⚠️ PEGA AQUÍ TU NUEVA URL DE LA VERSIÓN 5.0 ⚠️
        const API_URL = "https://script.google.com/macros/s/AKfycbyfNAabSsdYrncvAp8J8FoFDQgAnlVFm2Vk0yinu1jT3dzenr1nPvUBPR6_BnbsLIaa/exec";
        const LOGO_URL = "img/psicologia.png"; 

        // --- API HELPERS ---
        const api = async (action, params = {}, method = 'GET') => {
            const url = `${API_URL}?action=${action}${method === 'GET' ? '&' + new URLSearchParams(params) : ''}`;
            const opts = method === 'POST' ? { method: 'POST', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(params) } : {};
            
            try {
                const res = await fetch(url, opts);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                return data;
            } catch (e) { throw new Error(e.message || "Error conexión"); }
        };

        // --- COMPONENTES ---

        const StatusFooter = () => {
            const [status, setStatus] = useState('Comprobando...');
            const [color, setColor] = useState('text-gray-500');

            useEffect(() => {
                api('status').then(d => {
                    if(d.version === 'v5.0') {
                        setStatus('Conectado: v5.0 (Listo)');
                        setColor('text-green-600');
                    } else {
                        setStatus(`Versión Incorrecta: ${d.version || 'Desconocida'} (Actualiza URL)`);
                        setColor('text-red-600');
                    }
                }).catch(e => {
                    setStatus('Error de conexión: ' + e.message);
                    setColor('text-red-600');
                });
            }, []);

            return (
                <div className={`fixed bottom-0 right-0 p-2 bg-white/90 border-t text-xs font-bold ${color} flex items-center gap-1 z-50`}>
                    <Database size={12}/> {status}
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const [creds, setCreds] = useState({email: '', pass: ''});
            const [loading, setLoading] = useState(false);

            const submit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const res = await api('adminLogin', creds);
                    if (res.success) onLogin(); else alert("Acceso denegado");
                } catch (e) { alert(e.message); }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center min-h-[60vh]">
                    <form onSubmit={submit} className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm border-t-4 border-[#8B0000] space-y-4">
                        <h2 className="text-2xl font-bold text-center">Acceso Editor</h2>
                        <input className="w-full p-2 border rounded" type="email" placeholder="Email" value={creds.email} onChange={e=>setCreds({...creds, email: e.target.value})} required />
                        <input className="w-full p-2 border rounded" type="password" placeholder="Contraseña" value={creds.pass} onChange={e=>setCreds({...creds, pass: e.target.value})} required />
                        <button disabled={loading} className="w-full bg-[#8B0000] text-white p-2 rounded hover:bg-red-900 font-bold transition">
                            {loading ? 'Verificando...' : 'Ingresar'}
                        </button>
                    </form>
                </div>
            );
        };

        const Dashboard = ({ onCreate, onEdit, onLogout }) => {
            const [forms, setForms] = useState([]);
            const [loading, setLoading] = useState(true);

            const load = () => {
                setLoading(true);
                api('getFormsList', { onlyPublic: false })
                    .then(data => { setForms(Array.isArray(data) ? data : []); setLoading(false); })
                    .catch(() => { setForms([]); setLoading(false); });
            };

            useEffect(load, []);

            const del = async (e, id) => {
                e.stopPropagation();
                if(!confirm("¿Borrar?")) return;
                try { await api('deleteForm', { formId: id }, 'POST'); load(); } catch(e){ alert(e.message); }
            };

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-3xl font-bold text-gray-800">Cuestionarios</h2>
                        <div className="flex gap-2">
                            <button onClick={onCreate} className="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 flex items-center gap-2"><Plus size={18}/> Nuevo</button>
                            <button onClick={onLogout} className="text-red-600 px-3 py-2 hover:bg-red-50 rounded"><LogOut size={18}/></button>
                        </div>
                    </div>
                    {loading ? <div className="text-center p-10"><RefreshCw className="animate-spin inline"/> Cargando...</div> : (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {forms.map(f => (
                                <div key={f.id} className="bg-white rounded-lg shadow hover:shadow-lg border border-gray-200 overflow-hidden">
                                    <div className="p-5">
                                        <div className="flex justify-between mb-2">
                                            <span className={`text-xs font-bold px-2 py-1 rounded uppercase ${f.status==='public'?'bg-green-100 text-green-800':'bg-gray-200'}`}>{f.status}</span>
                                            <button onClick={(e)=>del(e,f.id)} className="text-red-400 hover:text-red-600"><Trash2 size={14}/></button>
                                        </div>
                                        <h3 className="font-bold text-[#8B0000] truncate">{f.title}</h3>
                                        <p className="text-sm text-gray-500 line-clamp-2">{f.description}</p>
                                    </div>
                                    <div className="bg-gray-50 p-3 flex justify-around border-t">
                                        <button onClick={()=>onEdit(f.id)} className="text-blue-600 font-bold text-sm flex items-center gap-1"><Edit size={14}/> Editar</button>
                                        <button onClick={()=>window.open(API_URL.replace('/exec','/dev') + `?action=getResponses&formId=${f.id}`)} className="text-purple-600 font-bold text-sm flex items-center gap-1"><BarChart2 size={14}/> Datos</button>
                                    </div>
                                </div>
                            ))}
                            {forms.length===0 && <div className="col-span-full text-center py-10 text-gray-400 border border-dashed rounded">No hay cuestionarios.</div>}
                        </div>
                    )}
                </div>
            );
        };

        const FormEditor = ({ formId, onBack }) => {
            const [form, setForm] = useState(null);
            const [saving, setSaving] = useState(false);
            const [tab, setTab] = useState('build');

            useEffect(() => {
                if(formId === 'new') {
                    setForm({ id: 'F'+Date.now(), settings: { title: "Nuevo", description: "", visibility: "private" }, sections: [{id: 's1', title: 'Sección 1', questions: []}] });
                } else {
                    api('getFormConfig', { formId }).then(setForm).catch(e => { alert(e.message); onBack(); });
                }
            }, [formId]);

            const save = async () => {
                if(!confirm("¿Guardar cambios?")) return;
                setSaving(true);
                try {
                    const res = await api('saveForm', { form }, 'POST');
                    if(res.success) alert("✅ Guardado Exitoso"); else alert("Error: "+res.message);
                } catch(e) { alert("Error: "+e.message); }
                setSaving(false);
            };

            const updateSettings = (k, v) => setForm(p => ({...p, settings: {...p.settings, [k]: v}}));
            const addSection = () => setForm(p => ({...p, sections: [...p.sections, {id: 's'+Date.now(), title: "Nueva Sección", questions: []}]}));
            const updateSection = (i, v) => setForm(p => { const s = [...p.sections]; s[i].title = v; return {...p, sections: s}; });
            const delSection = (i) => { if(confirm("Borrar?")) setForm(p => { const s = [...p.sections]; s.splice(i,1); return {...p, sections: s}; }); };
            const addQ = (si) => setForm(p => { const s = [...p.sections]; s[si].questions.push({id: 'q'+Date.now(), text: "Pregunta", type: "text"}); return {...p, sections: s}; });
            const updateQ = (si, qi, k, v) => setForm(p => { const s = [...p.sections]; s[si].questions[qi][k] = (k==='options' && typeof v === 'string') ? v.split(',') : v; return {...p, sections: s}; });
            const delQ = (si, qi) => setForm(p => { const s = [...p.sections]; s[si].questions.splice(qi,1); return {...p, sections: s}; });

            if(!form) return <div className="p-10 text-center">Cargando...</div>;

            return (
                <div className="flex h-screen bg-gray-100">
                    <div className="w-64 bg-white border-r flex flex-col">
                        <div className="p-4 border-b">
                            <button onClick={onBack} className="text-gray-500 hover:text-black mb-4 flex items-center gap-1"><ArrowLeft size={14}/> Volver</button>
                            <h2 className="font-bold truncate">{form.settings.title}</h2>
                        </div>
                        <div className="p-2 space-y-1">
                            <button onClick={()=>setTab('build')} className={`w-full text-left px-3 py-2 rounded ${tab==='build'?'bg-blue-50 text-blue-700 font-bold':'text-gray-600 hover:bg-gray-50'}`}>Constructor</button>
                            <button onClick={()=>setTab('settings')} className={`w-full text-left px-3 py-2 rounded ${tab==='settings'?'bg-blue-50 text-blue-700 font-bold':'text-gray-600 hover:bg-gray-50'}`}>Configuración</button>
                        </div>
                        <div className="mt-auto p-4 border-t">
                            <button onClick={save} disabled={saving} className="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 disabled:opacity-50">{saving ? 'Guardando...' : 'Guardar Todo'}</button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-8">
                        {tab === 'settings' && (
                            <div className="max-w-xl mx-auto bg-white p-6 rounded shadow space-y-4">
                                <h3 className="font-bold text-lg">Configuración</h3>
                                <div><label className="block text-sm font-bold">Título</label><input className="w-full border p-2 rounded" value={form.settings.title} onChange={e=>updateSettings('title', e.target.value)} /></div>
                                <div><label className="block text-sm font-bold">Descripción</label><textarea className="w-full border p-2 rounded h-24" value={form.settings.description} onChange={e=>updateSettings('description', e.target.value)} /></div>
                                <div><label className="block text-sm font-bold">Visibilidad</label><select className="w-full border p-2 rounded" value={form.settings.visibility} onChange={e=>updateSettings('visibility', e.target.value)}><option value="private">Privado</option><option value="public">Público</option></select></div>
                            </div>
                        )}
                        {tab === 'build' && (
                            <div className="max-w-3xl mx-auto space-y-6 pb-20">
                                {form.sections.map((s, si) => (
                                    <div key={s.id} className="bg-white rounded shadow border border-gray-200">
                                        <div className="bg-blue-50 p-4 border-b flex justify-between items-center">
                                            <input className="bg-transparent font-bold text-lg text-[#8B0000] w-full outline-none" value={s.title} onChange={e=>updateSection(si, e.target.value)} />
                                            <button onClick={()=>delSection(si)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button>
                                        </div>
                                        <div className="p-4 space-y-4">
                                            {s.questions.map((q, qi) => (
                                                <div key={q.id} className="border p-4 rounded bg-gray-50/50 hover:shadow-sm">
                                                    <div className="flex gap-2 mb-2">
                                                        <input className="flex-1 p-2 border rounded" placeholder="Pregunta" value={q.text} onChange={e=>updateQ(si, qi, 'text', e.target.value)} />
                                                        <select className="p-2 border rounded" value={q.type} onChange={e=>updateQ(si, qi, 'type', e.target.value)}><option value="text">Texto</option><option value="textarea">Párrafo</option><option value="select">Lista</option><option value="radio">Radio</option><option value="checkbox">Checkbox</option></select>
                                                    </div>
                                                    {['select','radio','checkbox'].includes(q.type) && <input className="w-full p-2 border rounded text-sm mb-2" placeholder="Opciones (separar por coma)" value={q.options?.join(',')} onChange={e=>updateQ(si, qi, 'options', e.target.value)} />}
                                                    <div className="flex justify-between items-center">
                                                        <input className="text-xs p-1 border rounded w-1/2" placeholder="URL Imagen" value={q.imageUrl||''} onChange={e=>updateQ(si, qi, 'imageUrl', e.target.value)} />
                                                        <button onClick={()=>delQ(si, qi)} className="text-xs text-red-500 hover:underline">Eliminar</button>
                                                    </div>
                                                    {q.imageUrl && <img src={q.imageUrl} className="h-16 mt-2 rounded border" />}
                                                </div>
                                            ))}
                                            <button onClick={()=>addQ(si)} className="w-full py-2 border-2 border-dashed rounded text-gray-400 hover:text-blue-500 font-bold">+ Pregunta</button>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={addSection} className="w-full py-3 bg-white border shadow text-gray-600 font-bold hover:bg-gray-50 rounded">+ Añadir Sección</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const StudentForm = ({ form, onBack }) => {
            const [answers, setAnswers] = useState({});
            const [sending, setSending] = useState(false);

            const handleChange = (qid, val) => setAnswers(p => ({ ...p, [qid]: val }));

            const submit = async () => {
                if(!confirm("¿Enviar?")) return;
                setSending(true);
                try {
                    const res = await api('submitResponse', { formId: form.id, data: answers }, 'POST');
                    if (res.success) { alert("¡Enviado!"); onBack(); }
                    else alert("Error: " + res.message);
                } catch (e) { alert("Error: " + e.message); }
                setSending(false);
            };

            return (
                <div className="bg-gray-100 min-h-screen pb-20">
                    <div className="bg-[#8B0000] text-white h-16 flex items-center px-6 shadow sticky top-0 z-50 justify-between">
                        <button onClick={onBack} className="flex items-center gap-1 font-bold opacity-80 hover:opacity-100"><ArrowLeft size={18}/> Salir</button>
                        <button onClick={submit} disabled={sending} className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-full font-bold shadow flex items-center gap-2">
                            {sending ? 'Enviando...' : <>Enviar <Send size={16}/></>}
                        </button>
                    </div>
                    
                    <div className="max-w-3xl mx-auto p-4 md:p-8 space-y-6">
                        <div className="bg-white rounded-lg shadow-lg border-t-8 border-[#8B0000] p-8">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">{form.settings.title}</h1>
                            <p className="text-gray-600 whitespace-pre-wrap">{form.settings.description}</p>
                        </div>

                        {form.sections.map(s => (
                            <div key={s.id} className="bg-white rounded-lg shadow overflow-hidden">
                                <div className="bg-[#8B0000] text-white px-6 py-3 font-bold">{s.title}</div>
                                <div className="p-6 space-y-8">
                                    {s.questions.map(q => (
                                        <div key={q.id} className="space-y-2">
                                            <label className="block text-gray-800 font-bold">{q.text} {q.required && <span className="text-red-500">*</span>}</label>
                                            {q.imageUrl && <img src={q.imageUrl} className="max-w-full h-auto rounded border mb-2 max-h-64 object-contain" />}
                                            
                                            {q.type === 'text' && <input className="w-full p-3 border rounded" onChange={e=>handleChange(q.id, e.target.value)} />}
                                            {q.type === 'textarea' && <textarea className="w-full p-3 border rounded h-24" onChange={e=>handleChange(q.id, e.target.value)} />}
                                            {q.type === 'number' && <input type="number" className="w-full p-3 border rounded" onChange={e=>handleChange(q.id, e.target.value)} />}
                                            {q.type === 'select' && <select className="w-full p-3 border rounded bg-white" onChange={e=>handleChange(q.id, e.target.value)}><option value="">Seleccionar...</option>{q.options?.map(o=><option key={o} value={o}>{o}</option>)}</select>}
                                            {q.type === 'radio' && <div className="space-y-2">{q.options?.map(o => <label key={o} className="flex items-center gap-2 cursor-pointer border p-2 rounded hover:bg-gray-50"><input type="radio" name={q.id} value={o} onChange={e=>handleChange(q.id, e.target.value)} /><span>{o}</span></label>)}</div>}
                                            {q.type === 'checkbox' && <div className="space-y-2">{q.options?.map(o => <label key={o} className="flex items-center gap-2 cursor-pointer border p-2 rounded hover:bg-gray-50"><input type="checkbox" value={o} onChange={e => { const old = answers[q.id] || []; handleChange(q.id, e.target.checked ? [...old, o] : old.filter(x=>x!==o)); }} /><span>{o}</span></label>)}</div>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [activeForm, setActiveForm] = useState(null);
            const [forms, setForms] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                setLoading(true);
                api('getFormsList', { onlyPublic: true }).then(d => { setForms(Array.isArray(d)?d:[]); setLoading(false); }).catch(()=>setLoading(false));
            }, []);

            const openForm = (id) => {
                setLoading(true);
                api('getFormConfig', { formId: id }).then(d => { setActiveForm(d); setView('student'); setLoading(false); }).catch(e => { alert(e.message); setLoading(false); });
            };

            if (view === 'home') return (
                <div>
                    <div className="bg-[#8B0000] text-white shadow-lg sticky top-0 z-50 h-16 flex items-center px-6 justify-between">
                        <div className="flex items-center gap-3"><div className="bg-white p-1 rounded-full"><img src={LOGO_URL} className="w-8 h-8 object-contain" /></div><h1 className="font-serif font-bold text-lg tracking-wide">Plataforma Académica</h1></div>
                        <button onClick={() => setView('login')} className="text-xs opacity-70 hover:opacity-100 flex items-center gap-1 border border-white/30 px-2 py-1 rounded"><Lock size={12}/> Editor</button>
                    </div>
                    <div className="max-w-4xl mx-auto p-8">
                        <div className="text-center mb-12"><h2 className="text-4xl font-bold text-gray-800 mb-4">Bienvenido</h2><p className="text-gray-600">Selecciona un cuestionario.</p></div>
                        {loading ? <div className="text-center">Cargando...</div> : 
                            <div className="grid gap-4">
                                {forms.map(f => (
                                    <div key={f.id} onClick={() => openForm(f.id)} className="bg-white p-6 rounded-xl shadow border-l-8 border-[#8B0000] cursor-pointer hover:shadow-lg transition flex justify-between items-center group">
                                        <div><h3 className="text-xl font-bold text-gray-800 group-hover:text-red-700">{f.title}</h3><p className="text-gray-500 text-sm mt-1 line-clamp-2">{f.description}</p></div>
                                        <ArrowRight className="text-gray-300 group-hover:text-red-600" />
                                    </div>
                                ))}
                                {forms.length === 0 && <div className="text-center p-10 text-gray-400 border border-dashed rounded">No hay cuestionarios públicos.</div>}
                            </div>
                        }
                    </div>
                    <StatusFooter />
                </div>
            );

            if (view === 'login') return <div><div className="bg-[#8B0000] h-16 w-full fixed top-0"></div><div className="pt-20"><Login onLogin={() => setView('dash')} /></div><StatusFooter /></div>;
            if (view === 'dash') return <div><div className="bg-[#8B0000] text-white h-16 flex items-center px-6 shadow"><span className="font-bold">Panel Editor</span></div><Dashboard onCreate={() => { setActiveForm('new'); setView('editor'); }} onEdit={(id) => { setActiveForm(id); setView('editor'); }} onLogout={() => setView('home')} /><StatusFooter /></div>;
            if (view === 'editor') return <><FormEditor formId={activeForm} onBack={() => setView('dash')} /><StatusFooter /></>;
            if (view === 'student') return <><StudentForm form={activeForm} onBack={() => setView('home')} /><StatusFooter /></>;
            return <div>Error estado</div>;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
