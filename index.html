<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Psiconet - Malla Curricular</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LUCIDE ICONS -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        psych: {
                            blue: '#002855', // Azul Oscuro Institucional
                            red: '#881313',  // Rojo Oscuro Institucional
                        },
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
                    },
                    animation: {
                        'fade-in-down': 'fadeInDown 0.5s ease-out',
                    },
                    keyframes: {
                        fadeInDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos de Impresión */
        @media print {
            @page { margin: 1.5cm; size: A4; }
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            .no-print, header, #view-map, #footer-legend, #download-modal, #map-instructions { display: none !important; }
            main { height: auto !important; overflow: visible !important; display: block !important; position: relative !important; }
            #view-report { display: block !important; position: static !important; height: auto !important; overflow: visible !important; background: white !important; }
            
            input:not([type="checkbox"]), textarea, select { 
                border: none !important; 
                border-bottom: 1px solid #002855 !important;
                padding: 0 !important; 
                font-weight: 500 !important; 
                color: #0f172a !important; 
                background: transparent !important; 
                width: 100% !important;
                resize: none;
                appearance: none;
            }
            input::placeholder, textarea::placeholder { color: transparent !important; }
            
            input[type="checkbox"] {
                appearance: auto !important;
                border: 1px solid #000 !important;
                display: inline-block !important;
            }

            label { display: block !important; color: #64748b !important; font-size: 10px !important; text-transform: uppercase !important; font-weight: bold !important; margin-bottom: 2px !important; }
            .break-inside-avoid { page-break-inside: avoid; }
            .print-clean-container { border: none !important; padding: 0 !important; background: transparent !important; }
            img { display: block !important; max-width: 100% !important; }
            #header-img { max-height: 120px !important; width: auto !important; }
        }
    </style>
</head>
<body class="bg-white text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER (Adaptado a Móvil) -->
    <header class="bg-white border-b-4 border-psych-red px-4 py-3 md:px-6 md:py-4 flex flex-col md:flex-row justify-between items-center shadow-md z-20 relative no-print gap-3 md:gap-0 transition-all duration-300">
        <div class="flex items-center justify-between w-full md:w-auto">
            <div class="flex items-center gap-3">
                <button id="btn-back" class="hidden p-2 hover:bg-slate-100 rounded-full transition-colors" onclick="switchView('map')">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-psych-blue"></i>
                </button>
                <div>
                    <!-- Logo más pequeño en móvil -->
                    <img src="img/Encabezado.png" alt="Psiconet" class="h-10 md:h-16 object-contain">
                </div>
            </div>
        </div>
        
        <div class="flex flex-col md:flex-row gap-3 items-center w-full md:w-auto">
            <!-- Input oculto en móvil para ahorrar espacio, se usa el del reporte -->
            <input type="text" id="quick-name" placeholder="Nombre del Estudiante" class="border border-slate-300 rounded-md px-3 py-1.5 text-sm w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-psych-blue hidden md:block" oninput="syncInputs(this.value, 'name')">
            
            <div id="controls-map" class="flex gap-2 w-full md:w-auto">
                <button onclick="switchView('report')" class="flex-1 md:flex-none flex justify-center items-center gap-2 bg-psych-blue text-white px-4 py-2 rounded-lg hover:bg-slate-900 transition-colors shadow-sm text-sm border-b-2 border-slate-900 active:scale-95">
                    <i data-lucide="file-text" class="w-4 h-4"></i> Click aqui para continuar con tu reporte de avance académico.
                </button>
                <button onclick="downloadJSON()" class="flex-none flex items-center gap-2 bg-white text-psych-red border border-psych-red px-3 py-2 rounded-lg hover:bg-red-50 transition-colors text-sm active:scale-95" title="Descargar Datos JSON">
                    <i data-lucide="download" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="controls-report" class="hidden w-full md:w-auto">
                <button onclick="showDownloadModal()" class="w-full md:w-auto flex justify-center items-center gap-2 bg-psych-red text-white px-6 py-2 rounded-lg hover:bg-red-900 transition-colors shadow-md animate-pulse font-medium active:scale-95">
                    <i data-lucide="file-down" class="w-4 h-4"></i> Finalizar y Descargar
                </button>
            </div>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="flex-1 relative overflow-hidden bg-slate-50">
        
        <!-- INSTRUCCIONES FLOTANTES (Adaptadas a Móvil) -->
        <div id="map-instructions" class="absolute top-4 left-4 right-4 md:left-6 md:right-auto md:w-96 z-40 pointer-events-none no-print transition-all duration-300">
            <!-- Se mantiene max-h-[80vh] y overflow-y-auto para permitir scroll con el texto largo -->
            <div class="bg-white/95 backdrop-blur shadow-2xl rounded-xl border-l-4 border-psych-blue p-3 md:p-4 pointer-events-auto animate-fade-in-down ring-1 ring-slate-900/5 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-start gap-3">
                    <div class="flex gap-3">
                        <div class="mt-1 bg-blue-50 p-2 rounded-lg text-psych-blue shadow-sm border border-blue-100 flex-shrink-0 h-fit">
                            <i data-lucide="mouse-pointer-2" class="w-4 h-4 md:w-5 md:h-5"></i>
                        </div>
                        <div class="pr-2">
                            <h3 class="font-bold text-slate-800 text-xs md:text-sm uppercase tracking-wide">Instrucciones Importantes</h3>
                            <p class="text-[10px] md:text-xs text-slate-500 mb-3">(Dale click a la <span class="font-bold text-slate-800">X</span> una vez acabes de leer)</p>
                            
                            <div class="space-y-2.5">
                                <p class="text-[10px] md:text-xs text-slate-600 leading-relaxed bg-slate-50 p-2 rounded border border-slate-100"><span class="font-bold text-psych-blue">1.-</span> Llena la malla curricular interactiva según tu avance académico, por favor <span class="font-bold text-slate-800 underline">se sincero</span> ya que estos datos son de total importancia para la transición a la nueva malla curricular.</p>
                                
                                <p class="text-[10px] md:text-xs text-slate-600 leading-relaxed"><span class="font-bold text-psych-blue">2.-</span> Al final a la derecha se encuentran las materias electivas y talleres, el requisito es pasar al menos <span class="font-bold text-slate-800">4 electivas y 4 talleres</span>, si marcas 4 de cada uno se dara por completada esa area, si no hay una electiva o taller que hayas cursado en esa misma seccion de electiva o taller marca una de las tarjetas que dicen <span class="font-bold italic text-slate-700">OTRA ELECTIVA / OTRO TALLER</span>.</p>
                                
                                <p class="text-[10px] md:text-xs text-slate-600 leading-relaxed"><span class="font-bold text-psych-blue">3.-</span> En el tema de los <span class="font-black text-slate-800">MODS</span> vendrián a ser las áreas que uno escoge a partir de <span class="font-bold">9no y 10mo Semestre</span> y <span class="font-bold text-red-600 underline">solo deberían escoger una de ellas</span>.</p>
                                
                                <div class="grid grid-cols-2 gap-2 my-2">
                                    <p class="text-[10px] md:text-xs text-slate-600 leading-relaxed bg-emerald-50 p-1.5 rounded border border-emerald-100"><span class="font-bold text-psych-blue">4.-</span> Indica <span class="font-bold text-emerald-600 uppercase">aprobado (verde)</span> las materias, electivas y talleres que ya venciste.</p>
                                    
                                    <p class="text-[10px] md:text-xs text-slate-600 leading-relaxed bg-amber-50 p-1.5 rounded border border-amber-100"><span class="font-bold text-psych-blue">5.-</span> Indica <span class="font-bold text-amber-600 uppercase">cursando (amarillo)</span> si aún estas avanzando la materia.</p>
                                    
                                    <p class="text-[10px] md:text-xs text-slate-600 leading-relaxed bg-blue-50 p-1.5 rounded border border-blue-100"><span class="font-bold text-psych-blue">6.-</span> Indica <span class="font-bold text-blue-600 uppercase">adelantado (azul)</span> si hiciste un levantamiento.</p>
                                    
                                    <p class="text-[10px] md:text-xs text-slate-600 leading-relaxed bg-red-50 p-1.5 rounded border border-red-100"><span class="font-bold text-psych-blue">7.-</span> Indica <span class="font-bold text-psych-red uppercase">reprobado (rojo)</span> si reprobaste una materia.</p>
                                </div>
                                
                                <p class="text-[10px] md:text-xs text-slate-600 leading-relaxed border-t border-slate-200 pt-2"><span class="font-bold text-psych-blue">8.-</span> Una vez terminada esta parte de la malla interactiva, en la parte superior derecha debes ingresar tu <span class="font-bold text-slate-800">nombre completo</span>, al lado derecho de donde ingresas tu nombre dale click al <span class="font-bold text-blue-600">boton azul</span> para seguir con el formulario, lo llenas y sigue las instrucciones que te dará al dar click el <span class="font-bold text-psych-red">boton rojo</span> en la parte superior derecha con el nombre de <span class="font-bold">FINALIZAR Y DESCARGAR</span>.</p>
                            </div>

                            <h3 class="font-bold text-slate-800 text-xs md:text-sm mt-4 mb-2 bg-slate-100 p-1 rounded text-center">9.-¿Cómo actualizar tu avance?</h3>
                            <p class="text-[10px] md:text-xs text-slate-600 mt-1 leading-relaxed text-center mb-2">
                                Toca las materias para cambiar su estado:
                            </p>
                            <div class="mt-2 flex flex-wrap gap-1 items-center justify-center">
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-white border border-slate-300 text-slate-500 shadow-sm">Pendiente</span>
                                <span class="text-slate-300 text-[10px]"><i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-100 text-amber-700 border border-amber-200 shadow-sm">Cursando</span>
                                <span class="text-slate-300 text-[10px]"><i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-700 border border-emerald-200 shadow-sm">Aprobada</span>
                                <span class="text-slate-300 text-[10px]"><i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-900 border border-blue-500 shadow-sm">Adelantada</span>
                                <span class="text-slate-300 text-[10px]"><i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-50 text-psych-red border border-psych-red shadow-sm">Reprobada</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="dismissInstructions()" class="text-slate-400 hover:text-psych-red bg-slate-50 hover:bg-red-50 p-1.5 rounded-md transition-colors h-fit sticky top-0" title="Cerrar instrucciones">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA: MAPA (Scroll Táctil) -->
        <div id="view-map" class="absolute inset-0 overflow-auto p-4 md:p-8 touch-pan-x touch-pan-y" onscroll="updateLines()">
            <div class="relative min-w-[3400px] min-h-[1400px]">
                <svg id="connections-layer" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" /></marker>
                        <marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#002855" /></marker>
                    </defs>
                </svg>
                <div id="semesters-container" class="flex gap-8 md:gap-12 z-10 relative"></div>
            </div>
        </div>

        <!-- VISTA: REPORTE (Padding reducido en móvil) -->
        <div id="view-report" class="hidden absolute inset-0 overflow-auto bg-white">
            <div class="max-w-4xl mx-auto p-4 md:p-8 min-h-screen">
                
                <!-- IMAGEN DE ENCABEZADO -->
                <div class="mb-6 w-full flex justify-center">
                    <img id="header-img" src="img/Encabezado.png" alt="Encabezado Institucional" class="h-24 md:h-32 object-contain" onerror="this.style.display='none'">
                </div>

                <!-- Encabezado del Reporte -->
                <div class="border-b-4 border-psych-blue pb-6 mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-4 gap-4 md:gap-0">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-psych-blue uppercase tracking-tight">Reporte Académico</h1>
                            <h2 class="text-lg md:text-xl text-psych-red font-medium">Psicología - UAGRM</h2>
                        </div>
                        <div class="text-left md:text-right">
                            <div class="text-sm text-slate-500 font-medium">Fecha de Emisión</div>
                            <div class="text-lg font-bold text-slate-800" id="report-date"></div>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl border border-slate-200 print-clean-container">
                        <h3 class="text-sm font-bold text-psych-blue uppercase mb-4 tracking-wider no-print">Datos del Estudiante</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 print:gap-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><i data-lucide="user" class="w-3 h-3 no-print"></i>Nombre Completo</label>
                                <input type="text" id="input-name" placeholder="Ej. Juan Pérez" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-slate-900 font-bold focus:ring-2 focus:ring-psych-blue focus:outline-none" oninput="syncInputs(this.value, 'name')">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><i data-lucide="hash" class="w-3 h-3 no-print"></i>Registro Universitario</label>
                                <input type="text" id="input-registry" placeholder="Ej. 202300000" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-slate-900 font-medium focus:ring-2 focus:ring-psych-blue focus:outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3 no-print"></i>Número de celular</label>
                                <input type="number" inputmode="numeric" id="input-phone" placeholder="Ej. 70000000" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-slate-900 font-medium focus:ring-2 focus:ring-psych-blue focus:outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><i data-lucide="mail" class="w-3 h-3 no-print"></i>Correo Electrónico</label>
                                <input type="email" id="input-email" placeholder="Ej. estudiante@uagrm.edu.bo" class="w-full bg-white border border-slate-300 rounded px-3 py-2 text-slate-900 font-medium focus:ring-2 focus:ring-psych-blue focus:outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas Automáticas (Grid adaptado) -->
                <div class="mb-8">
                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-3 tracking-wider">Estado Académico Actual</h3>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3 md:gap-4">
                        <!-- Nivel Alcanzado (Full width en móvil para destacar) -->
                        <div class="col-span-2 md:col-span-2 bg-blue-50 p-4 rounded-lg border border-blue-100 text-center flex flex-col justify-center print-clean-container shadow-sm relative overflow-hidden">
                            <span id="stat-max-semester" class="text-3xl font-black text-psych-blue">1º Sem</span>
                            <span class="text-[10px] text-slate-500 uppercase font-bold mt-1">Nivel Actual</span>
                            <div id="stat-leveling-container" class="mt-2 flex flex-col items-center">
                                <span id="stat-leveling-status" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">Calculando...</span>
                            </div>
                        </div>
                        <!-- Avance (Full width en móvil row 2) -->
                        <div class="col-span-2 md:col-span-1 bg-white p-4 rounded-lg border border-slate-200 text-center flex flex-col justify-center print-clean-container">
                            <span id="stat-progress" class="text-3xl font-black text-slate-700">0%</span>
                            <span class="text-[10px] text-slate-400 uppercase font-bold mt-1">Avance</span>
                        </div>
                        <!-- Contadores (Grid pequeño) -->
                        <div class="col-span-1 md:col-span-1 bg-white p-3 rounded-lg border border-emerald-100 shadow-sm flex flex-col items-center justify-center print-clean-container">
                            <span id="stat-approved" class="text-2xl font-bold text-emerald-600">0</span>
                            <span class="text-xs text-slate-600 font-medium">Aprob.</span>
                        </div>
                        <div class="col-span-1 md:col-span-1 bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex flex-col items-center justify-center">
                            <span id="stat-pending" class="text-2xl font-bold text-slate-500">67</span>
                            <span class="text-xs text-slate-600 font-medium">Pend.</span>
                        </div>
                        <div class="col-span-2 md:col-span-1 bg-white p-3 rounded-lg border border-red-100 shadow-sm flex flex-col items-center justify-center print-clean-container">
                            <span id="stat-failed" class="text-2xl font-bold text-psych-red">0</span>
                            <span class="text-xs text-slate-600 font-medium">Reprob.</span>
                        </div>
                    </div>
                </div>

                <!-- DIAGNÓSTICO INSTITUCIONAL FORMAL -->
                <div class="mb-8 break-inside-avoid print:break-before-page">
                    <div class="bg-slate-50 border-2 border-slate-200 rounded-xl p-4 md:p-8 relative shadow-sm">
                        <!-- Título & Objetivo -->
                        <div class="mb-8 border-b-2 border-psych-blue pb-6">
                            <h2 class="text-xl md:text-2xl font-bold text-psych-blue text-center mb-4 uppercase tracking-tight">Encuesta para Estudiantes sobre Situación Académica y Transición al Nuevo Currículo</h2>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-psych-blue">
                                <p class="text-xs md:text-sm text-slate-700 text-justify">
                                    <span class="font-bold text-psych-blue">OBJETIVO:</span> Conocer tu situación actual, tus percepciones sobre el proceso de transición curricular y tus preferencias respecto a las medidas de adaptación.
                                </p>
                            </div>
                        </div>

                        <!-- Sección 1 -->
                        <div class="mb-8">
                            <h3 class="text-xs md:text-sm font-bold text-white bg-psych-blue px-4 py-1.5 rounded-t-lg inline-block uppercase tracking-wider shadow-sm">Sección 1.- Datos Generales</h3>
                            <div class="border-t-2 border-psych-blue bg-white p-4 md:p-6 rounded-b-lg rounded-tr-lg shadow-sm grid grid-cols-1 md:grid-cols-2 gap-6 border-l border-r border-b border-slate-200">
                                
                                <div class="md:col-span-2">
                                    <p class="text-xs text-slate-500 italic flex items-center gap-1">
                                        <i data-lucide="info" class="w-3 h-3"></i>
                                        Se sincero con tus respuestas, recuerda que con estos datos nos ayudas a que la transición sea más fácil para todos.
                                    </p>
                                </div>
                                
                                <!-- Q6 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">Número de Materias registradas este semestre:</label>
                                    <div class="flex items-center gap-3 bg-slate-50 p-2 rounded border border-slate-200">
                                        <span class="text-xs font-semibold text-slate-600 uppercase flex-1">• Número de materias inscritas:</span>
                                        <input type="number" inputmode="numeric" id="survey-q6" class="w-16 border-b-2 border-slate-300 focus:border-psych-blue text-center text-sm font-bold text-psych-blue focus:outline-none bg-transparent" placeholder="#">
                                    </div>
                                </div>

                                <!-- Q7 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">¿Trabajas mientras estudias?</label>
                                    <div class="bg-slate-50 p-2 rounded border border-slate-200">
                                        <select id="survey-q7" class="w-full border-b-2 border-slate-300 focus:border-psych-blue text-sm focus:outline-none bg-transparent py-1 font-medium text-slate-700">
                                            <option value="" disabled selected>Selecciona una opción...</option>
                                            <option value="Sí">Sí</option>
                                            <option value="No">No</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Q8 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">¿Cuántas horas al día puedes realmente dedicarle al estudio?</label>
                                    <div class="bg-slate-50 p-2 rounded border border-slate-200">
                                        <input type="number" inputmode="numeric" id="survey-q8" class="w-full border-b-2 border-slate-300 focus:border-psych-blue text-sm focus:outline-none bg-transparent py-1 font-medium text-slate-700" placeholder="Indicar número">
                                    </div>
                                </div>

                                <!-- Q9 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">Estado general de avance de acuerdo a la malla curricular:</label>
                                    <div class="bg-slate-50 p-2 rounded border border-slate-200">
                                        <select id="survey-q9" class="w-full border-b-2 border-slate-300 focus:border-psych-blue text-sm focus:outline-none bg-transparent py-1 font-medium text-slate-700">
                                            <option value="" disabled selected>Selecciona una opción...</option>
                                            <option value="Voy al día">Voy al día</option>
                                            <option value="Ligeramente atrasado(a)">Ligeramente atrasado(a)</option>
                                            <option value="Atraso moderado">Atraso moderado</option>
                                            <option value="Atraso significativo">Atraso significativo</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección 3 -->
                        <div class="mb-8">
                            <h3 class="text-xs md:text-sm font-bold text-white bg-psych-blue px-4 py-1.5 rounded-t-lg inline-block uppercase tracking-wider shadow-sm">Sección 3.- Materias Atrasadas</h3>
                            <div class="border-t-2 border-psych-blue bg-white p-4 md:p-6 rounded-b-lg rounded-tr-lg shadow-sm border-l border-r border-b border-slate-200">
                                 <p class="text-xs text-slate-500 italic mb-4 flex items-center gap-1">
                                    <i data-lucide="info" class="w-3 h-3"></i>
                                    Responde solo si tienes materias atrasadas.
                                 </p>
                                 <!-- Q13 -->
                                 <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">¿Estas materias atrasadas afectan tu avance hacia la nueva malla curricular?</label>
                                    <div class="bg-slate-50 p-3 rounded border border-slate-200">
                                        <select id="survey-q13" class="w-full border-b-2 border-slate-300 focus:border-psych-blue text-sm focus:outline-none bg-transparent py-1 mb-3 font-medium text-slate-700" onchange="toggleDepende(this)">
                                            <option value="" disabled selected>Selecciona...</option>
                                            <option value="Sí">Sí</option>
                                            <option value="No">No</option>
                                            <option value="No sé">No sé</option>
                                            <option value="Depende">Depende</option>
                                        </select>
                                        <input type="text" id="dep-13" class="hidden w-full border-b border-slate-300 text-sm italic text-slate-600 focus:outline-none focus:border-psych-blue py-1 animate-fade-in" placeholder="Explica: Depende de qué...">
                                    </div>
                                 </div>
                            </div>
                        </div>

                        <!-- Sección 5 -->
                        <div class="mb-8">
                            <h3 class="text-xs md:text-sm font-bold text-white bg-psych-blue px-4 py-1.5 rounded-t-lg inline-block uppercase tracking-wider shadow-sm">Sección 5.- Expectativas</h3>
                            <div class="border-t-2 border-psych-blue bg-white p-4 md:p-6 rounded-b-lg rounded-tr-lg shadow-sm space-y-6 border-l border-r border-b border-slate-200">
                                <!-- Q16 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">¿Cómo te sientes respecto a la implementación de la nueva malla curricular?</label>
                                    <div class="bg-slate-50 p-3 rounded border border-slate-200">
                                        <select id="survey-q16" class="w-full border-b-2 border-slate-300 focus:border-psych-blue text-sm focus:outline-none bg-transparent py-1 font-medium text-slate-700">
                                            <option value="" disabled selected>Selecciona...</option>
                                            <option value="Motivado">Motivado(a): lo veo como una oportunidad para mejorar la formación.</option>
                                            <option value="Cauteloso">Cauteloso(a): prefiero observar cómo se desarrolla antes de opinar.</option>
                                            <option value="Preocupado">Preocupado(a): temo que afecte mi avance académico.</option>
                                            <option value="Indiferente">Indiferente: no creo que cambie mucho mi situación.</option>
                                            <option value="Confundido">Confundido(a): aún no comprendo bien el nuevo plan.</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Q17 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">¿Qué crees que aportará la nueva malla curricular?</label>
                                    <div class="bg-slate-50 p-3 rounded border border-slate-200">
                                        <select id="survey-q17" class="w-full border-b-2 border-slate-300 focus:border-psych-blue text-sm focus:outline-none bg-transparent py-1 mb-3 font-medium text-slate-700" onchange="toggleOtro(this, 'other-17')">
                                            <option value="" disabled selected>Selecciona...</option>
                                            <option value="Organización">Mejor organización del avance académico</option>
                                            <option value="Secuencias">Secuencias más claras y lógicas de contenido</option>
                                            <option value="Flexibilidad">Mayor flexibilidad</option>
                                            <option value="Claridad">Claridad en perfiles y competencias</option>
                                            <option value="Ninguna">Ninguna de las anteriores</option>
                                            <option value="Otro">Otra opinión</option>
                                        </select>
                                        <input type="text" id="other-17" class="hidden w-full border-b border-slate-300 text-sm italic text-slate-600 focus:outline-none focus:border-psych-blue py-1 animate-fade-in" placeholder="Escribe tu opinión aquí...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección 6 -->
                        <div class="mb-8">
                            <h3 class="text-xs md:text-sm font-bold text-white bg-psych-blue px-4 py-1.5 rounded-t-lg inline-block uppercase tracking-wider shadow-sm">Sección 6.- Transición</h3>
                            <div class="border-t-2 border-psych-blue bg-white p-4 md:p-6 rounded-b-lg rounded-tr-lg shadow-sm space-y-6 border-l border-r border-b border-slate-200">
                                <!-- Q18 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-3">Medidas útiles (selección múltiple):</label>
                                    <div id="survey-q18-container" class="space-y-2 ml-1 md:ml-2 bg-slate-50 p-3 md:p-4 rounded border border-slate-200">
                                        <label class="flex items-start md:items-center gap-3 text-sm text-slate-700 font-medium cursor-pointer hover:bg-white p-1 rounded transition-colors"><input type="checkbox" value="Cursos verano" class="accent-psych-blue w-4 h-4 mt-0.5 md:mt-0"> <span class="leading-tight">Cursos de verano intensivos (para adelantar o recuperar)</span></label>
                                        <label class="flex items-start md:items-center gap-3 text-sm text-slate-700 font-medium cursor-pointer hover:bg-white p-1 rounded transition-colors"><input type="checkbox" value="Semestres igualacion" class="accent-psych-blue w-4 h-4 mt-0.5 md:mt-0"> <span class="leading-tight">Semestres de igualación sin prerrequisitos</span></label>
                                        <label class="flex items-start md:items-center gap-3 text-sm text-slate-700 font-medium cursor-pointer hover:bg-white p-1 rounded transition-colors"><input type="checkbox" value="Cursos nivelacion" class="accent-psych-blue w-4 h-4 mt-0.5 md:mt-0"> <span class="leading-tight">Cursos especiales de nivelación en el semestre</span></label>
                                        <label class="flex items-start md:items-center gap-3 text-sm text-slate-700 font-medium cursor-pointer hover:bg-white p-1 rounded transition-colors"><input type="checkbox" value="Tutorias" class="accent-psych-blue w-4 h-4 mt-0.5 md:mt-0"> <span class="leading-tight">Tutorías académicas personalizadas</span></label>
                                        <label class="flex items-start md:items-center gap-3 text-sm text-slate-700 font-medium cursor-pointer hover:bg-white p-1 rounded transition-colors"><input type="checkbox" value="Flexibilidad prerrequisitos" class="accent-psych-blue w-4 h-4 mt-0.5 md:mt-0"> <span class="leading-tight">Adaptación flexible de prerrequisitos por única vez</span></label>
                                        <div class="pt-2">
                                            <label class="flex items-center gap-3 text-sm text-slate-700 font-medium mb-1"><input type="checkbox" id="q18-other-check" value="Otro" class="accent-psych-blue w-4 h-4"> Otros:</label>
                                            <input type="text" id="q18-other-text" class="w-full border-b border-slate-300 text-sm italic ml-7 focus:outline-none focus:border-psych-blue bg-transparent" placeholder="Especifique...">
                                        </div>
                                    </div>
                                </div>
                                <!-- Q19 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">Prioridad absoluta (elige una):</label>
                                    <div class="bg-slate-50 p-3 rounded border border-slate-200">
                                        <select id="survey-q19" class="w-full border-b-2 border-slate-300 focus:border-psych-blue text-sm focus:outline-none bg-transparent py-1 font-medium text-slate-700">
                                            <option value="" disabled selected>Selecciona...</option>
                                            <option value="Verano">Cursos de verano intensivos (para adelantar o recuperar)</option>
                                            <option value="Igualación">Semestres de igualación sin prerrequisitos</option>
                                            <option value="Nivelación">Cursos de nivelación</option>
                                            <option value="Tutorías">Tutorías académicas personalizadas</option>
                                            <option value="Flexibilidad">Adaptación flexible de prerrequisitos por única vez</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección 7 -->
                        <div class="mb-4">
                            <h3 class="text-xs md:text-sm font-bold text-white bg-psych-blue px-4 py-1.5 rounded-t-lg inline-block uppercase tracking-wider shadow-sm">Sección 7.- Comentarios</h3>
                            <div class="border-t-2 border-psych-blue bg-white p-4 md:p-6 rounded-b-lg rounded-tr-lg shadow-sm border-l border-r border-b border-slate-200">
                                <!-- Q20 -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-800 mb-2">Propuesta para mejorar la transición (respuesta abierta):</label>
                                    <textarea id="survey-q20" rows="4" class="w-full border-2 border-slate-300 rounded-lg p-3 text-sm focus:border-psych-blue focus:outline-none focus:ring-1 focus:ring-blue-100 transition-all" placeholder="Escribe tu propuesta aquí..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Footer del Formulario -->
                        <div class="mt-6 text-center no-print">
                            <p class="text-[10px] md:text-xs text-slate-400 mb-4">Complete todos los campos antes de descargar.</p>
                        </div>
                    </div>
                </div>

                <!-- Listado Materias -->
                <div id="report-semesters-list" class="space-y-6"></div>

                <div class="mt-12 pt-8 border-t border-slate-300 flex justify-between text-xs text-slate-400">
                    <p>Generado por Psiconet</p>
                    <p class="border-t border-slate-400 px-8 pt-1">Firma Director(a)</p>
                </div>
            </div>
        </div>
    </main>

    <footer id="footer-legend" class="no-print absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 md:px-6 md:py-3 rounded-full shadow-lg border border-slate-200 z-50 flex gap-4 md:gap-6 items-center whitespace-nowrap overflow-x-auto max-w-[90%] md:max-w-none no-scrollbar">
        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider mr-1 md:mr-2">Leyenda:</span>
        <div class="flex items-center gap-1.5 md:gap-2"><div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full border bg-white border-gray-300"></div><span class="text-[10px] md:text-xs text-slate-700">Pendiente</span></div>
        <div class="flex items-center gap-1.5 md:gap-2"><div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full border bg-amber-100 border-amber-500"></div><span class="text-[10px] md:text-xs text-slate-700">Cursando</span></div>
        <div class="flex items-center gap-1.5 md:gap-2"><div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full border bg-emerald-100 border-emerald-500"></div><span class="text-[10px] md:text-xs text-slate-700">Aprobada</span></div>
        <div class="flex items-center gap-1.5 md:gap-2"><div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full border bg-blue-100 border-blue-500"></div><span class="text-[10px] md:text-xs text-slate-700">Adelantada</span></div>
        <div class="flex items-center gap-1.5 md:gap-2"><div class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full border bg-red-50 border-psych-red"></div><span class="text-[10px] md:text-xs text-slate-700">Reprobada</span></div>
    </footer>

    <!-- MODAL DE DESCARGA (Responsivo) -->
    <div id="download-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden border border-slate-200 m-4">
            <!-- Modal Header -->
            <div class="bg-psych-blue p-4 flex items-center justify-between">
                <h3 class="text-white font-bold text-lg flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5"></i> Finalizar Proceso
                </h3>
                <button onclick="closeDownloadModal()" class="text-white/80 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-4 md:p-6 max-h-[80vh] overflow-y-auto">
                <!-- PASO 1: GUARDAR DATOS -->
                <div class="bg-blue-50 border-l-4 border-psych-blue p-4 rounded mb-6 shadow-sm">
                    <h4 class="text-psych-blue font-bold text-sm mb-2 uppercase flex items-center gap-2">
                        <span class="bg-psych-blue text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">1</span>
                        Registrar Datos
                    </h4>
                    <p class="text-xs text-slate-600 mb-3">
                        Guarda tu reporte en nuestra base de datos.
                    </p>
                    <button id="btn-send-sheets" onclick="sendToGoogleSheets()" class="w-full flex justify-center items-center gap-2 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors shadow-sm font-bold text-sm active:scale-95">
                        <i data-lucide="sheet" class="w-4 h-4"></i> Guardar en Sheets
                    </button>
                </div>

                <!-- PASO 2: DESCARGAR -->
                <div class="border-t border-slate-200 pt-4">
                     <h4 class="text-slate-700 font-bold text-sm mb-3 uppercase flex items-center gap-2">
                        <span class="bg-slate-400 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs">2</span>
                        Descargar y Enviar
                    </h4>
                    <p class="text-slate-600 text-xs leading-relaxed mb-4">
                        Descarga el PDF y envíalo indicando tu <strong>Nombre Completo y Registro</strong>.
                    </p>
                    
                    <div class="space-y-2">
                        <a href="https://wa.me/59160904656" target="_blank" class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:border-green-500 hover:bg-green-50 group transition-all active:bg-green-100">
                            <span class="flex items-center gap-2 text-slate-700 text-xs font-medium group-hover:text-green-700">
                                <i data-lucide="message-circle" class="w-4 h-4 text-green-600"></i> +591 60904656
                            </span>
                            <i data-lucide="external-link" class="w-3 h-3 text-slate-400 group-hover:text-green-600"></i>
                        </a>
                        <a href="https://wa.me/59162829160" target="_blank" class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:border-green-500 hover:bg-green-50 group transition-all active:bg-green-100">
                            <span class="flex items-center gap-2 text-slate-700 text-xs font-medium group-hover:text-green-700">
                                <i data-lucide="message-circle" class="w-4 h-4 text-green-600"></i> +591 62829160
                            </span>
                            <i data-lucide="external-link" class="w-3 h-3 text-slate-400 group-hover:text-green-600"></i>
                        </a>
                    </div>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="bg-slate-50 p-4 border-t border-slate-200 flex justify-end gap-3">
                <button onclick="closeDownloadModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors">
                    Cancelar
                </button>
                <button onclick="confirmDownload()" class="px-4 py-2 text-sm font-bold text-white bg-psych-blue rounded hover:bg-slate-900 transition-colors shadow-sm flex items-center gap-2 active:scale-95">
                    <i data-lucide="file-down" class="w-4 h-4"></i> Descargar PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN DE GOOGLE SHEETS
        // ==========================================
        //  ↓↓↓  ¡¡¡ PEGA TU URL DE APPS SCRIPT AQUÍ ABAJO !!!  ↓↓↓
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxgejJxR6gL8coGxPwH2OBd2FYyCxp0YYvyb-Q3muo7XjDrM_DXDD-fEuYLNQ-LAldy/exec"; 
        //  ↑↑↑  Ejemplo: "https://script.google.com/macros/s/AKfy.../exec"
        // ==========================================

        const REQUIREMENTS = { TRONCALES_TOTAL: 59, ELECTIVES_NEEDED: 4, TALLERES_NEEDED: 4, TOTAL_SUBJECTS_DEGREE: 67, TOTAL_SEMESTERS: 10 };
        const STATUS_TYPES = {
            pending: { id: 'pending', label: 'Pendiente', color: 'bg-white border-slate-300 text-slate-600', printColor: 'text-gray-400', icon: 'clock' },
            approved: { id: 'approved', label: 'Aprobada', color: 'bg-emerald-100 border-emerald-500 text-emerald-900', printColor: 'text-emerald-700 font-bold', icon: 'check-circle' },
            curring: { id: 'curring', label: 'Cursando', color: 'bg-amber-100 border-amber-500 text-amber-900', printColor: 'text-amber-600 font-bold', icon: 'play-circle' },
            advanced: { id: 'advanced', label: 'Adelantada', color: 'bg-blue-100 border-blue-500 text-blue-900', printColor: 'text-blue-600 font-bold', icon: 'fast-forward' },
            failed: { id: 'failed', label: 'Reprobada', color: 'bg-red-50 border-psych-red text-psych-red', printColor: 'text-psych-red font-bold', icon: 'x-circle' },
        };
        const STATUS_ORDER = ['pending', 'curring', 'approved', 'advanced', 'failed'];
        
        const semestersData = [
            { id: 1, name: "1er Semestre", subjects: [{ id: "FIL-101", name: "Filosofía", type: "troncal" }, { id: "EST-121", name: "Estadística I", type: "troncal" }, { id: "CSO-101", name: "Sociología I", type: "troncal" }, { id: "ANT-100", name: "Antropología Cultural", type: "troncal" }, { id: "PSI-101", name: "Psicología I", type: "troncal" }, { id: "BIO-100", name: "Biopsicología", type: "troncal" }, { id: "DEP-112", name: "Estrategias de Aprendizaje", type: "troncal" }] },
            { id: 2, name: "2do Semestre", subjects: [{ id: "FIL-150", name: "Epistemología", prereqs: ["FIL-101"], type: "troncal" }, { id: "EST-152", name: "Estadística II", prereqs: ["EST-121"], type: "troncal" }, { id: "CSO-150", name: "Sociología II", prereqs: ["CSO-101"], type: "troncal" }, { id: "ANT-150", name: "Antropología Cultural Boliviana", prereqs: ["ANT-100"], type: "troncal" }, { id: "PSI-150", name: "Psicología II", prereqs: ["PSI-101"], type: "troncal" }, { id: "BIO-150", name: "Psicofisiología", prereqs: ["BIO-100"], type: "troncal" }] },
            { id: 3, name: "3er Semestre", subjects: [{ id: "INV-200", name: "Investigación I", prereqs: ["EST-152", "FIL-150"], type: "troncal" }, { id: "CSO-200", name: "Psicología Social", prereqs: ["CSO-150"], type: "troncal" }, { id: "CSO-201", name: "Psicología Etnoecológica", prereqs: ["ANT-150"], type: "troncal" }, { id: "PSI-200", name: "Desarrollo Humano I", prereqs: ["PSI-150"], type: "troncal" }, { id: "PSI-203", name: "Teorías y Sistemas I", prereqs: ["PSI-150"], type: "troncal" }, { id: "BIO-200", name: "Neuropsicología I", prereqs: ["BIO-150"], type: "troncal" }, { id: "PSI-202", name: "Aprendizaje", prereqs: ["PSI-150", "BIO-150"], type: "troncal" }] },
            { id: 4, name: "4to Semestre", subjects: [{ id: "INV-250", name: "Investigación II", prereqs: ["INV-200"], type: "troncal" }, { id: "CSO-250", name: "Psicología Grupal y Organizacional", prereqs: ["CSO-200"], type: "troncal" }, { id: "PSI-254", name: "Desarrollo Humano II", prereqs: ["PSI-200"], type: "troncal" }, { id: "PSI-256", name: "Teorías y Sistemas II", prereqs: ["PSI-202", "PSI-203"], type: "troncal" }, { id: "BIO-250", name: "Neuropsicología II", prereqs: ["BIO-200"], type: "troncal" }, { id: "PSI-255", name: "Etología", prereqs: ["PSI-202"], type: "troncal" }] },
            { id: 5, name: "5to Semestre", subjects: [{ id: "INV-300", name: "Investigación III", prereqs: ["INV-250"], type: "troncal" }, { id: "CSO-300", name: "Comportamiento y Sociedad", prereqs: ["CSO-250"], type: "troncal" }, { id: "PSI-310", name: "Psicología de la Personalidad I", prereqs: ["PSI-254"], type: "troncal" }, { id: "PSI-311", name: "Evaluación Psicológica I", prereqs: ["PSI-254"], type: "troncal" }, { id: "PSI-313", name: "Psicopatología I", prereqs: ["PSI-254", "BIO-250"], type: "troncal" }, { id: "PSI-312", name: "Psicología Cognitiva I", prereqs: ["PSI-256"], type: "troncal" }] },
            { id: 6, name: "6to Semestre", subjects: [{ id: "INV-350", name: "Investigación IV", prereqs: ["INV-300"], type: "troncal" }, { id: "CSO-350", name: "Diagnóstico de Necesidades", prereqs: ["CSO-300"], type: "troncal" }, { id: "PSI-350", name: "Psicología de la Personalidad II", prereqs: ["PSI-310"], type: "troncal" }, { id: "PSI-351", name: "Evaluación Psicológica II", prereqs: ["PSI-311"], type: "troncal" }, { id: "PSI-354", name: "Psicopatología II", prereqs: ["PSI-313"], type: "troncal" }, { id: "PSI-353", name: "Psicoanálisis", prereqs: ["PSI-256", "PSI-310"], type: "troncal" }, { id: "PSI-352", name: "Psicología Cognitiva II", prereqs: ["PSI-312"], type: "troncal" }] },
            { id: 7, name: "7mo Semestre", subjects: [{ id: "INV-400", name: "Investigación V", prereqs: ["INV-350"], type: "troncal" }, { id: "CSO-400", name: "Proyectos I", prereqs: ["CSO-350"], type: "troncal" }, { id: "CSO-401", name: "Téc. de Int. Socio-Organizacional I", prereqs: ["CSO-201", "CSO-350"], type: "troncal" }, { id: "PSI-401", name: "Técnicas Proyectivas", prereqs: ["PSI-351", "PSI-353"], type: "troncal" }, { id: "PSI-400", name: "Téc. de Int. Clínica I", prereqs: ["PSI-350", "PSI-354"], type: "troncal" }, { id: "PSI-402", name: "Téc. de Int. Educativa I", prereqs: ["PSI-352"], type: "troncal" }] },
            { id: 8, name: "8vo Semestre", subjects: [{ id: "INV-450", name: "Investigación VI", prereqs: ["INV-400"], type: "troncal" }, { id: "CSO-450", name: "Proyectos II", prereqs: ["CSO-400"], type: "troncal" }, { id: "CSO-451", name: "Téc. de Int. Socio-Organizacional II", prereqs: ["CSO-401"], type: "troncal" }, { id: "PSI-451", name: "Psicodiagnóstico", prereqs: ["PSI-401"], type: "troncal" }, { id: "PSI-450", name: "Téc. de Int. Clínica II", prereqs: ["PSI-400"], type: "troncal" }, { id: "PSI-452", name: "Téc. de Int. Educativa II", prereqs: ["PSI-402"], type: "troncal" }] },
            { id: 9, name: "9no Semestre (MODs)", subjects: [{ id: "DEP-500", name: "Ética Profesional I", prereqs: ["PSI-451"], type: "troncal" }, { id: "HUM-CLI-1", name: "Abordaje Clínica I Humanista", prereqs: ["PSI-450"], type: "mod-hum" }, { id: "HUM-EDU-1", name: "Abordaje Educativo I Humanista", prereqs: ["PSI-452"], type: "mod-hum" }, { id: "HUM-SOC-1", name: "Abordaje Socio-Org. I Humanista", prereqs: ["CSO-451"], type: "mod-hum" }, { id: "COG-CLI-1", name: "Abordaje Clínica I Cognitivo Conductual", prereqs: ["PSI-450"], type: "mod-cc" }, { id: "COG-EDU-1", name: "Abordaje Educativo I Cognitivo Conductual", prereqs: ["PSI-452"], type: "mod-cc" }, { id: "COG-SOC-1", name: "Abordaje Socio-Org. I Cognitivo Conductual", prereqs: ["CSO-451"], type: "mod-cc" }, { id: "AMB-AMB-1", name: "Psicología Ambiental I (Ambiental Comunitario)", prereqs: ["CSO-451"], type: "mod-amb" }, { id: "AMB-COM-1", name: "Psicología Comunitaria I (Ambiental Comunitario)", prereqs: ["PSI-451"], type: "mod-amb" }, { id: "AMB-ORG-1", name: "Psicología de las Organizaciones I (Ambiental Comunitario)", prereqs: ["PSI-451"], type: "mod-amb" }, { id: "PSA-CLI-1", name: "Abordaje Clínica I Psicoanalítico", prereqs: ["PSI-450"], type: "mod-psa" }, { id: "PSA-EDU-1", name: "Abordaje Educativo I Psicoanalítico", prereqs: ["PSI-452"], type: "mod-psa" }, { id: "PSA-SOC-1", name: "Abordaje Socio-Org. I Psicoanalítico", prereqs: ["CSO-451"], type: "mod-psa" }] },
            { id: 10, name: "10mo Semestre (MODs)", subjects: [{ id: "DEP-501", name: "Ética Profesional II", prereqs: ["DEP-500"], type: "troncal" }, { id: "HUM-CLI-2", name: "Abordaje Clínica II Humanista", prereqs: ["HUM-CLI-1"], type: "mod-hum" }, { id: "HUM-EDU-2", name: "Abordaje Educativo II Humanista", prereqs: ["HUM-EDU-1"], type: "mod-hum" }, { id: "HUM-SOC-2", name: "Abordaje Socio-Org. II Humanista", prereqs: ["HUM-SOC-1"], type: "mod-hum" }, { id: "COG-CLI-2", name: "Abordaje Clínica II Cognitivo Conductual", prereqs: ["COG-CLI-1"], type: "mod-cc" }, { id: "COG-EDU-2", name: "Abordaje Educativo II Cognitivo Conductual", prereqs: ["COG-EDU-1"], type: "mod-cc" }, { id: "COG-SOC-2", name: "Abordaje Socio-Org. II Cognitivo Conductual", prereqs: ["COG-SOC-1"], type: "mod-cc" }, { id: "AMB-AMB-2", name: "Psicología Ambiental II (Ambiental Comunitario)", prereqs: ["AMB-AMB-1"], type: "mod-amb" }, { id: "AMB-COM-2", name: "Psicología Comunitaria II (Ambiental Comunitario)", prereqs: ["AMB-COM-1"], type: "mod-amb" }, { id: "AMB-ORG-2", name: "Psicología de las Organizaciones II (Ambiental Comunitario)", prereqs: ["AMB-ORG-1"], type: "mod-amb" }, { id: "PSA-CLI-2", name: "Abordaje Clínica II Psicoanalítico", prereqs: ["PSA-CLI-1"], type: "mod-psa" }, { id: "PSA-EDU-2", name: "Abordaje Educativo II Psicoanalítico", prereqs: ["PSA-EDU-1"], type: "mod-psa" }, { id: "PSA-SOC-2", name: "Abordaje Socio-Org. II Psicoanalítico", prereqs: ["PSA-SOC-1"], type: "mod-psa" }] },
            { id: 11, name: "Electivas (4 Requeridas)", subjects: [{ id: "ELE-GRU-1", name: "Grupo Relacional I", type: "electiva" }, { id: "ELE-GRU-2", name: "Grupo Relacional II", prereqs: ["ELE-GRU-1"], type: "electiva" }, { id: "ELE-COM-1", name: "Computación I", type: "electiva" }, { id: "ELE-COM-2", name: "Computación II", prereqs: ["ELE-COM-1"], type: "electiva" }, { id: "ELE-REC", name: "Técnicas Recreacionales", type: "electiva" }, { id: "ELE-NAT-1", name: "Lengua Nativa I", type: "electiva" }, { id: "ELE-NAT-2", name: "Lengua Nativa II", prereqs: ["ELE-NAT-1"], type: "electiva" }, { id: "ELE-NAT-3", name: "Lengua Nativa III", prereqs: ["ELE-NAT-2"], type: "electiva" }, { id: "ELE-NAT-4", name: "Lengua Nativa IV", prereqs: ["ELE-NAT-3"], type: "electiva" }, { id: "ELE-ING-1", name: "Idioma Inglés I", type: "electiva" }, { id: "ELE-ING-2", name: "Idioma Inglés II", prereqs: ["ELE-ING-1"], type: "electiva" }, { id: "ELE-EXT-1", name: "OTRA ELECTIVA", type: "electiva" }, { id: "ELE-EXT-2", name: "OTRA ELECTIVA", type: "electiva" }, { id: "ELE-EXT-3", name: "OTRA ELECTIVA", type: "electiva" }, { id: "ELE-EXT-4", name: "OTRA ELECTIVA", type: "electiva" }] },
            { id: 12, name: "Talleres (4 Requeridos)", subjects: [{ id: "TAL-MOV", name: "Movimientos Indígenas", prereqs: ["ANT-150"], type: "taller" }, { id: "TAL-TER", name: "Territorios Pueblos IND.", prereqs: ["ANT-150"], type: "taller" }, { id: "TAL-REL", name: "Relac. Interétnicas", prereqs: ["ANT-150"], type: "taller" }, { id: "TAL-IDE", name: "Identidad y Culturas", prereqs: ["CSO-300"], type: "taller" }, { id: "TAL-INF", name: "Soc. Infancia y Juv.", prereqs: ["PSI-254"], type: "taller" }, { id: "TAL-TRA", name: "Soc. Organización y Trabajo", prereqs: ["CSO-250"], type: "taller" }, { id: "TAL-MIG", name: "Soc. Migraciones", prereqs: ["CSO-150"], type: "taller" }, { id: "TAL-DEL", name: "Delito y Sociedad", prereqs: ["CSO-300"], type: "taller" }, { id: "TAL-PSA", name: "Clínica Psicoanalítica", prereqs: ["PSI-353"], type: "taller" }, { id: "TAL-ADO", name: "Psicoanálisis Adolescentes", prereqs: ["PSI-353"], type: "taller" }, { id: "TAL-PSI", name: "Psicosomática", prereqs: ["BIO-250"], type: "taller" }, { id: "TAL-NIN", name: "Psicoanálisis Niños", prereqs: ["PSI-353"], type: "taller" }, { id: "TAL-SAL", name: "Salud Mental Com.", prereqs: ["PSI-354"], type: "taller" }, { id: "TAL-COM", name: "Psicología de la Comunicación", prereqs: ["PSI-400"], type: "taller" }, { id: "TAL-CON", name: "Técnicas Conciliación", prereqs: ["CSO-401"], type: "taller" }, { id: "TAL-ROG", name: "Terapia Rogeriana", prereqs: ["PSI-400"], type: "taller" }, { id: "TAL-DRA", name: "Psicodrama", prereqs: ["PSI-400"], type: "taller" }, { id: "TAL-POS", name: "Psicología Positiva", prereqs: ["PSI-400"], type: "taller" }, { id: "TAL-DIF", name: "Dificultades Aprendizaje", prereqs: ["PSI-202"], type: "taller" }, { id: "TAL-FAR", name: "Psicofarmacología", prereqs: ["PSI-400"], type: "taller" }, { id: "TAL-HIG", name: "Psicohigiene", prereqs: ["PSI-400"], type: "taller" }, { id: "TAL-VOC", name: "Orientación Vocacional", prereqs: ["PSI-402"], type: "taller" }, { id: "TAL-SEX", name: "Psicología de la Sexualidad", prereqs: ["PSI-313"], type: "taller" }, { id: "TAL-ORG", name: "Psicología Organizacional", prereqs: ["CSO-250"], type: "taller" }, { id: "TAL-ESP", name: "Educación Especial", prereqs: ["PSI-402"], type: "taller" }, { id: "TAL-DEP", name: "Psicología del Deporte", prereqs: ["BIO-100"], type: "taller" }, { id: "TAL-SOC", name: "Sociología de la Salud", prereqs: ["CSO-150"], type: "taller" }, { id: "TAL-GEN", name: "Género y Desarrollo", prereqs: ["CSO-200"], type: "taller" }, { id: "TAL-CFL", name: "Teoría Conflicto Social", prereqs: ["CSO-200"], type: "taller" }, { id: "TAL-ECO", name: "Ecología Social", prereqs: ["CSO-201"], type: "taller" }, { id: "TAL-EXT-1", name: "OTRO TALLER", type: "taller" }, { id: "TAL-EXT-2", name: "OTRO TALLER", type: "taller" }, { id: "TAL-EXT-3", name: "OTRO TALLER", type: "taller" }, { id: "TAL-EXT-4", name: "OTRO TALLER", type: "taller" }] }
        ];

        let subjectStates = {};
        let hoveredSubject = null;

        function init() {
            semestersData.forEach(sem => sem.subjects.forEach(sub => subjectStates[sub.id] = 'pending'));
            renderMap();
            updateLines();
            renderReportList();
            safeSetText('report-date', new Date().toLocaleDateString());
            updateStats();
            lucide.createIcons();
            window.addEventListener('resize', updateLines);
        }

        // --- Helper Seguro para asignar texto ---
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function renderMap() {
            const container = document.getElementById('semesters-container');
            container.innerHTML = '';
            semestersData.forEach(sem => {
                const col = document.createElement('div');
                col.className = 'flex flex-col w-40 md:w-56 gap-3 md:gap-4 flex-shrink-0';
                col.innerHTML = `
                    <div class="text-center py-1.5 md:py-2 bg-psych-blue text-white rounded-t-lg font-bold shadow-md sticky top-0 z-20 text-xs md:text-base">
                        ${sem.name}
                        ${sem.id === 11 ? `<div class="text-[9px] md:text-[10px] font-normal opacity-80 mt-1" id="map-header-ele">0/4 Completadas</div>` : ''}
                        ${sem.id === 12 ? `<div class="text-[9px] md:text-[10px] font-normal opacity-80 mt-1" id="map-header-tal">0/4 Completados</div>` : ''}
                    </div>
                `;
                const subjectsContainer = document.createElement('div');
                subjectsContainer.className = 'flex flex-col gap-3 md:gap-6 pt-2 md:pt-4';
                sem.subjects.forEach(sub => {
                    const card = document.createElement('div');
                    card.id = `subject-${sub.id}`;
                    card.className = getCardClasses(sub.id, sub.type);
                    card.onclick = () => toggleSubject(sub.id);
                    card.onmouseenter = () => handleMouseEnter(sub.id);
                    card.onmouseleave = () => handleMouseLeave();
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-1 pointer-events-none">
                            <span class="text-[8px] md:text-[9px] font-bold opacity-60 bg-gray-200 px-1 rounded text-slate-700">${sub.id}</span>
                            <i data-lucide="${STATUS_TYPES['pending'].icon}" class="w-3 h-3 md:w-3.5 md:h-3.5 icon-status"></i>
                        </div>
                        <h3 class="text-[10px] md:text-xs font-bold leading-tight min-h-[32px] md:min-h-[40px] flex items-center pointer-events-none">${sub.name}</h3>
                        <div class="mt-1 flex justify-end pointer-events-none">
                            <span class="text-[8px] md:text-[9px] px-1.5 py-0.5 rounded-full border ${getTypeStyle(sub.type)}">${getTypeLabel(sub.type)}</span>
                        </div>
                    `;
                    subjectsContainer.appendChild(card);
                });
                col.appendChild(subjectsContainer);
                container.appendChild(col);
            });
        }

        function renderReportList() {
            const container = document.getElementById('report-semesters-list');
            container.innerHTML = '';
            semestersData.forEach(sem => {
                const block = document.createElement('div');
                block.className = 'break-inside-avoid';
                let extraInfo = '';
                if(sem.id === 11) extraInfo = `<span class="text-xs font-normal text-slate-500" id="rep-header-ele">Completado: 0/4</span>`;
                if(sem.id === 12) extraInfo = `<span class="text-xs font-normal text-slate-500" id="rep-header-tal">Completado: 0/4</span>`;
                block.innerHTML = `
                    <h3 class="text-xs md:text-sm font-bold bg-slate-100 text-psych-blue py-1 px-3 mb-2 border-l-4 border-psych-blue uppercase print:bg-slate-200 flex justify-between">
                        <span>${sem.name}</span>
                        ${extraInfo}
                    </h3>
                `;
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-1';
                sem.subjects.forEach(sub => {
                    const row = document.createElement('div');
                    row.id = `rep-subject-${sub.id}`;
                    row.className = 'flex justify-between items-center text-xs py-1 border-b border-slate-100 print:border-slate-200';
                    grid.appendChild(row);
                });
                block.appendChild(grid);
                container.appendChild(block);
            });
            updateReportUI();
        }

        function toggleSubject(id) {
            const current = subjectStates[id];
            const nextIdx = (STATUS_ORDER.indexOf(current) + 1) % STATUS_ORDER.length;
            subjectStates[id] = STATUS_ORDER[nextIdx];
            updateCardUI(id);
            updateStats();
            updateReportUI();
        }
        
        function handleMouseEnter(id) {
            // Deshabilitar hover en pantallas táctiles para evitar "pegajosidad"
            if (window.matchMedia("(hover: hover)").matches) {
                hoveredSubject = id;
                updateOpacity();
                updateLinesOpacity();
            }
        }
        
        function handleMouseLeave() {
            if (window.matchMedia("(hover: hover)").matches) {
                hoveredSubject = null;
                updateOpacity();
                updateLinesOpacity();
            }
        }

        function updateCardUI(id) {
            const el = document.getElementById(`subject-${id}`);
            const sub = getSubjectById(id);
            if(el) {
                el.className = getCardClasses(id, sub.type);
                const status = subjectStates[id];
                const iconName = STATUS_TYPES[status].icon;
                const iconContainer = el.querySelector('.icon-status');
                if(iconContainer) {
                    const newIcon = document.createElement('i');
                    newIcon.setAttribute('data-lucide', iconName);
                    // Adjust icons color
                    const iconColor = status === 'approved' ? 'text-emerald-600' : status === 'failed' ? 'text-psych-red' : status === 'advanced' ? 'text-blue-600' : 'text-slate-400';
                    newIcon.className = `w-3 h-3 md:w-3.5 md:h-3.5 icon-status ${iconColor}`;
                    iconContainer.replaceWith(newIcon);
                    lucide.createIcons();
                }
            }
        }

        function updateReportUI() {
            semestersData.forEach(sem => {
                sem.subjects.forEach(sub => {
                    const row = document.getElementById(`rep-subject-${sub.id}`);
                    if(row) {
                        const status = subjectStates[sub.id];
                        const config = STATUS_TYPES[status];
                        const iconColor = status === 'approved' ? 'text-emerald-600' : status === 'failed' ? 'text-psych-red' : status === 'advanced' ? 'text-blue-600' : status === 'curring' ? 'text-amber-600' : 'text-slate-300';
                        const iconHtml = status !== 'pending' ? `<i data-lucide="${config.icon}" class="w-3 h-3 ${iconColor}"></i>` : '';
                        row.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-slate-400 w-12 md:w-16">${sub.id}</span>
                                <span class="font-medium ${status !== 'pending' ? 'text-slate-900' : 'text-slate-500'} truncate max-w-[150px] md:max-w-none">${sub.name}</span>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <span class="${config.printColor} font-semibold uppercase text-[9px] md:text-[10px]">${config.label}</span>
                                ${iconHtml}
                            </div>
                        `;
                    }
                });
            });
            lucide.createIcons();
        }

        function getCardClasses(id, type) {
            const status = subjectStates[id] || 'pending';
            const config = STATUS_TYPES[status];
            // Ajustado padding y tamaños para móvil
            let classes = `relative p-2 md:p-3 rounded-lg border cursor-pointer shadow-sm transition-all duration-200 ${config.color} z-10`;
            // If default pending, add stronger border or shadow? No, keep clean.
            return classes;
        }

        function updateOpacity() {
            semestersData.forEach(sem => {
                sem.subjects.forEach(sub => {
                    const el = document.getElementById(`subject-${sub.id}`);
                    if(!el) return;
                    if (!hoveredSubject) {
                        el.style.opacity = '1';
                        el.classList.remove('blur-[1px]', 'scale-110', 'shadow-xl', 'ring-2', 'ring-psych-red', 'z-50', 'border-psych-red');
                        el.classList.add('z-10');
                        return;
                    }
                    const isHovered = hoveredSubject === sub.id;
                    const isRelated = isConnected(hoveredSubject, sub.id);
                    if (isHovered) {
                        el.style.opacity = '1';
                        el.classList.add('scale-110', 'shadow-xl', 'ring-2', 'ring-psych-red', 'z-50');
                        el.classList.remove('blur-[1px]', 'z-10');
                    } else if (isRelated) {
                        el.style.opacity = '1';
                        el.classList.remove('blur-[1px]', 'scale-110', 'shadow-xl', 'ring-2', 'ring-psych-red', 'z-50');
                         el.classList.add('z-10');
                    } else {
                        el.style.opacity = '0.3';
                        el.classList.add('blur-[1px]');
                        el.classList.remove('scale-110', 'shadow-xl', 'ring-2', 'ring-psych-red', 'z-50');
                        el.classList.add('z-10');
                    }
                });
            });
        }

        function updateLines() {
            const container = document.getElementById('view-map');
            const svg = document.getElementById('connections-layer');
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" /></marker>
                    <marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#002855" /></marker>
                </defs>
            `;
            const parentRect = svg.parentElement.getBoundingClientRect();
            semestersData.forEach(sem => {
                sem.subjects.forEach(sub => {
                    if (sub.prereqs) {
                        sub.prereqs.forEach(preId => {
                            const startEl = document.getElementById(`subject-${preId}`);
                            const endEl = document.getElementById(`subject-${sub.id}`);
                            if (startEl && endEl) {
                                const startRect = startEl.getBoundingClientRect();
                                const endRect = endEl.getBoundingClientRect();
                                const startX = startRect.right - parentRect.left;
                                const startY = startRect.top + (startRect.height/2) - parentRect.top;
                                const endX = endRect.left - parentRect.left;
                                const endY = endRect.top + (endRect.height/2) - parentRect.top;
                                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                                const d = `M ${startX} ${startY} C ${startX + 30} ${startY}, ${endX - 30} ${endY}, ${endX} ${endY}`; // Curvatura ajustada para tarjetas más cercanas en móvil
                                path.setAttribute("d", d);
                                path.setAttribute("stroke", "#002855"); // Azul Institucional
                                path.setAttribute("stroke-width", "2"); // Líneas ligeramente más finas
                                path.setAttribute("fill", "none");
                                path.setAttribute("marker-end", "url(#arrowhead-active)");
                                path.setAttribute("class", "transition-opacity duration-300 opacity-0");
                                path.setAttribute("data-from", preId);
                                path.setAttribute("data-to", sub.id);
                                svg.appendChild(path);
                            }
                        });
                    }
                });
            });
        }

        function updateLinesOpacity() {
            const paths = document.querySelectorAll('#connections-layer path');
            paths.forEach(path => {
                if (!hoveredSubject) {
                    path.classList.replace('opacity-100', 'opacity-0');
                    return;
                }
                const from = path.getAttribute("data-from");
                const to = path.getAttribute("data-to");
                if (from === hoveredSubject || to === hoveredSubject) {
                    path.classList.replace('opacity-0', 'opacity-100');
                } else {
                    path.classList.replace('opacity-100', 'opacity-0');
                }
            });
        }

        function updateStats() {
            let approvedTroncales = 0;
            let approvedElectives = 0;
            let approvedTalleres = 0;
            let curringCount = 0;
            let advancedCount = 0;
            let failedCount = 0;
            let maxSemester = 0;

            Object.keys(subjectStates).forEach(id => {
                const status = subjectStates[id];
                const sub = getSubjectById(id);
                
                if(status === 'curring') curringCount++;
                if(status === 'advanced') advancedCount++;
                if(status === 'failed') failedCount++;
                
                if (status === 'approved' || status === 'advanced') {
                     if (sub.type === 'troncal' || sub.type.startsWith('mod-')) {
                         approvedTroncales++;
                         const semId = getSemesterOfSubject(id);
                         if (semId > maxSemester) maxSemester = semId;
                     }
                     else if (sub.type === 'electiva') approvedElectives++;
                     else if (sub.type === 'taller') approvedTalleres++;
                }
            });

            // 1. Calcular deudas específicas en semestres INFERIORES o IGUALES al máximo alcanzado
            let debtSemesters = [];
            
            if (maxSemester > 0) {
                semestersData.forEach(sem => {
                    // Verificamos si es un semestre troncal/MOD (ids <= 10) y si es menor o igual al maxSemester
                    if (sem.id <= 10 && sem.id <= maxSemester) {
                        let hasPendingInThisSemester = false;
                        
                        // LÓGICA ESPECIAL PARA 9no y 10mo (MODs)
                        if (sem.id === 9 || sem.id === 10) {
                            // 1. Verificar Troncal (Ética)
                            const troncalSubject = sem.subjects.find(s => s.type === 'troncal');
                            const stTroncal = subjectStates[troncalSubject.id];
                            const isTroncalOk = stTroncal === 'approved' || stTroncal === 'advanced';

                            // 2. Verificar si al menos UN módulo completo (sus 3 materias) está aprobado
                            const modTypes = ['mod-hum', 'mod-cc', 'mod-amb', 'mod-psa'];
                            let isAnyModComplete = false;

                            for (const type of modTypes) {
                                const modSubjects = sem.subjects.filter(s => s.type === type);
                                // Verificar si TODAS las materias de este módulo están aprobadas
                                const isThisModComplete = modSubjects.every(s => {
                                    const st = subjectStates[s.id];
                                    return st === 'approved' || st === 'advanced';
                                });
                                
                                if (isThisModComplete) {
                                    isAnyModComplete = true;
                                    break; // Con uno basta
                                }
                            }

                            // Si falta la troncal O no se completó ningún módulo entero, hay deuda en este semestre
                            if (!isTroncalOk || !isAnyModComplete) {
                                hasPendingInThisSemester = true;
                            }

                        } else {
                            // LÓGICA ESTÁNDAR (1ro a 8vo)
                            // Si falta cualquier materia, es deuda
                            sem.subjects.forEach(sub => {
                                const status = subjectStates[sub.id];
                                if (status !== 'approved' && status !== 'advanced') {
                                    hasPendingInThisSemester = true;
                                }
                            });
                        }
                        
                        if (hasPendingInThisSemester) {
                            debtSemesters.push(sem.id);
                        }
                    }
                });
            }
            
            const effElectives = Math.min(approvedElectives, REQUIREMENTS.ELECTIVES_NEEDED);
            const effTalleres = Math.min(approvedTalleres, REQUIREMENTS.TALLERES_NEEDED);
            const totalEff = approvedTroncales + effElectives + effTalleres;
            
            const pending = Math.max(0, REQUIREMENTS.TOTAL_SUBJECTS_DEGREE - totalEff);
            const progress = Math.round((totalEff / REQUIREMENTS.TOTAL_SUBJECTS_DEGREE) * 100);
            
            safeSetText('stat-progress', `${Math.min(progress, 100)}%`);
            safeSetText('stat-approved', totalEff);
            safeSetText('stat-pending', pending);
            safeSetText('stat-curring', curringCount);
            safeSetText('stat-advanced', advancedCount);
            safeSetText('stat-failed', failedCount);
            
            // Nivel Actual = Semestre de la materia más alta aprobada
            const maxSemText = maxSemester > 0 ? `${maxSemester}º Sem` : '-';
            safeSetText('stat-max-semester', maxSemText);

            // Actualizar texto de Nivelación/Deuda
            const debtStatusEl = document.getElementById('stat-leveling-status');
            const debtDetailEl = document.getElementById('stat-leveling-container');
            
            if (debtStatusEl) {
                // Limpiar
                debtDetailEl.innerHTML = '';
                debtDetailEl.appendChild(debtStatusEl);

                if (maxSemester === 0) {
                     debtStatusEl.textContent = 'Iniciando';
                     debtStatusEl.className = "text-[10px] font-bold mt-1 px-2 py-0.5 rounded-full inline-block self-center bg-gray-100 text-gray-500";
                } else if (debtSemesters.length === 0) {
                     debtStatusEl.textContent = '¡Estás nivelado!';
                     debtStatusEl.className = "text-[10px] font-bold mt-1 px-2 py-0.5 rounded-full inline-block self-center bg-emerald-100 text-emerald-600";
                } else {
                     // Formatear texto de semestres pendientes (ej: "3º, 4º y 5º")
                     let debtText = "";
                     if (debtSemesters.length === 1) {
                         debtText = `${debtSemesters[0]}º`;
                     } else {
                         const last = debtSemesters.pop();
                         debtText = debtSemesters.join('º, ') + 'º y ' + last + 'º';
                     }
                     
                     debtStatusEl.textContent = `Pendientes: ${debtText}`; // Texto más corto para móvil
                     debtStatusEl.className = "text-[9px] md:text-[10px] font-bold mt-1 px-2 py-0.5 rounded-full inline-block self-center bg-red-100 text-psych-red text-center max-w-[150px] truncate"; 
                }
            }

            const txtEle = `${effElectives}/4`;
            const txtTal = `${effTalleres}/4`;
            
            safeSetText('map-header-ele', `${txtEle} Completadas`);
            safeSetText('map-header-tal', `${txtTal} Completados`);
            safeSetText('rep-header-ele', `Completado: ${txtEle} Completadas`);
            safeSetText('rep-header-tal', `Completado: ${txtTal} Completados`);
            
            updateDots('dots-electivas', approvedElectives, 4, 'bg-purple-500');
            updateDots('dots-talleres', approvedTalleres, 4, 'bg-orange-500');
            safeSetText('text-electivas', txtEle);
            safeSetText('text-talleres', txtTal);
        }
        
        function updateDots(containerId, count, max, colorClass) {
            const container = document.getElementById(containerId);
            if (!container) return; // Safety check
            container.innerHTML = '';
            for(let i=1; i<=max; i++) {
                const dot = document.createElement('div');
                dot.className = `w-3 h-3 rounded-full ${i <= count ? colorClass : 'bg-slate-200'} print:border print:border-slate-300 ${i<=count?'print:bg-slate-800':''}`;
                container.appendChild(dot);
            }
        }

        function dismissInstructions() {
            const el = document.getElementById('map-instructions');
            if (el) el.style.display = 'none';
        }

        function switchView(mode) {
            const map = document.getElementById('view-map');
            const rep = document.getElementById('view-report');
            const btnBack = document.getElementById('btn-back');
            const inputName = document.getElementById('quick-name');
            const ctrlMap = document.getElementById('controls-map');
            const ctrlRep = document.getElementById('controls-report');
            const footer = document.getElementById('footer-legend');
            
            // Instrucciones
            const instr = document.getElementById('map-instructions');
            
            if (mode === 'map') {
                map.classList.remove('hidden');
                rep.classList.add('hidden');
                btnBack.classList.add('hidden');
                inputName.classList.remove('hidden');
                ctrlMap.classList.remove('hidden');
                ctrlRep.classList.add('hidden');
                footer.classList.remove('hidden');
                
                // Mostrar instrucciones si no han sido cerradas manualmente (esto reinicia su visualización al volver al mapa)
                if(instr) instr.style.display = 'block';

                setTimeout(updateLines, 100);
            } else {
                map.classList.add('hidden');
                rep.classList.remove('hidden');
                btnBack.classList.remove('hidden');
                inputName.classList.add('hidden');
                ctrlMap.classList.add('hidden');
                ctrlRep.classList.remove('hidden');
                footer.classList.add('hidden');
                
                // Ocultar instrucciones en vista reporte
                if(instr) instr.style.display = 'none';
            }
        }
        
        function syncInputs(val, field) {
            if(field === 'name') {
                document.getElementById('quick-name').value = val;
                document.getElementById('input-name').value = val;
            }
        }
        
        function downloadJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(subjectStates));
            const name = document.getElementById('input-name').value || 'estudiante';
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", `malla_psicologia_${name}.json`);
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function getSubjectById(id) {
            for(let s of semestersData) {
                const sub = s.subjects.find(x => x.id === id);
                if(sub) return sub;
            }
            return null;
        }

        function getSemesterOfSubject(id) {
            for(let s of semestersData) {
                if (s.subjects.find(x => x.id === id)) return s.id;
            }
            return 0;
        }

        function isConnected(id1, id2) {
            const s1 = getSubjectById(id1);
            const s2 = getSubjectById(id2);
            if(s1 && s1.prereqs && s1.prereqs.includes(id2)) return true;
            if(s2 && s2.prereqs && s2.prereqs.includes(id1)) return true;
            return false;
        }
        
        function getTypeStyle(type) {
            switch (type) {
                case 'electiva': return 'bg-purple-200 text-purple-900 border-purple-300';
                case 'taller': return 'bg-orange-200 text-orange-900 border-orange-300';
                case 'mod-hum': return 'bg-pink-200 text-pink-900 border-pink-300'; 
                case 'mod-cc': return 'bg-cyan-200 text-cyan-900 border-cyan-300'; 
                case 'mod-amb': return 'bg-lime-200 text-lime-900 border-lime-300'; 
                case 'mod-psa': return 'bg-fuchsia-200 text-fuchsia-900 border-fuchsia-300'; 
                default: return 'bg-slate-50 text-slate-700 border-slate-200';
            }
        }
        function getTypeLabel(type) {
            if (type.startsWith('mod-')) return 'MOD';
            if (type === 'electiva') return 'Electiva';
            if (type === 'taller') return 'Taller';
            return 'Troncal';
        }

        // --- Nuevas Funciones para el Formulario ---
        function toggleDepende(select) {
            const input = document.getElementById('dep-13');
            if (select.value === 'Depende') {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
            }
        }

        function toggleOtro(select, id) {
            const input = document.getElementById(id);
            if (select.value === 'Otro') {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
            }
        }

        // --- Nuevas Funciones para el Modal ---
        function showDownloadModal() {
            document.getElementById('download-modal').classList.remove('hidden');
        }

        function closeDownloadModal() {
            document.getElementById('download-modal').classList.add('hidden');
        }

        function confirmDownload() {
            closeDownloadModal();
            setTimeout(() => {
                window.print();
            }, 300);
        }

        // --- FUNCIÓN PARA ENVIAR DATOS A GOOGLE SHEETS ---
        function sendToGoogleSheets() {
            const btn = document.getElementById('btn-send-sheets');
            const originalText = btn.innerHTML;
            
            if (GOOGLE_SCRIPT_URL === "" || GOOGLE_SCRIPT_URL === "") {
                alert("Error: Debes configurar la URL de tu Google Script en el código HTML antes de enviar.");
                return;
            }

            // Cambiar estado botón
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Enviando...`;
            lucide.createIcons();
            btn.disabled = true;

            // Recopilar Datos de la Encuesta (Checkbox Logic)
            const q18Checked = [];
            const checkboxes = document.querySelectorAll('#survey-q18-container input[type="checkbox"]:checked');
            checkboxes.forEach(chk => {
                if(chk.value === 'Otro') {
                    const otherText = document.getElementById('q18-other-text').value;
                    q18Checked.push(`Otro: ${otherText}`);
                } else {
                    q18Checked.push(chk.value);
                }
            });

            // Recopilar Q13 y Q17 con lógica condicional
            let q13Val = document.getElementById('survey-q13') ? document.getElementById('survey-q13').value : "";
            if (q13Val === "Depende") q13Val += ": " + document.getElementById('dep-13').value;

            let q17Val = document.getElementById('survey-q17') ? document.getElementById('survey-q17').value : "";
            if (q17Val === "Otro") q17Val += ": " + document.getElementById('other-17').value;

            // Calcular Electivas y Talleres para el reporte
            let countElectivas = 0;
            let countTalleres = 0;
            
            Object.keys(subjectStates).forEach(id => {
                const status = subjectStates[id];
                const sub = getSubjectById(id);
                
                if (status === 'approved' || status === 'advanced') {
                     if (sub.type === 'electiva') countElectivas++;
                     else if (sub.type === 'taller') countTalleres++;
                }
            });

            const payload = {
                // Datos Personales
                nombre: document.getElementById('input-name').value,
                registro: document.getElementById('input-registry').value,
                celular: document.getElementById('input-phone').value,
                correo: document.getElementById('input-email').value,
                
                // Estadísticas
                nivel: document.getElementById('stat-max-semester').innerText,
                avance: document.getElementById('stat-progress').innerText,
                aprobadas: document.getElementById('stat-approved').innerText,
                pendientes: document.getElementById('stat-pending').innerText,
                reprobadas: document.getElementById('stat-failed').innerText,

                // --- NUEVO: CONTADORES ESPECÍFICOS ---
                electivas_aprobadas: countElectivas + "/4",
                talleres_aprobados: countTalleres + "/4",
                
                // Encuesta
                q6_carga: document.getElementById('survey-q6') ? document.getElementById('survey-q6').value : "",
                q7_trabaja: document.getElementById('survey-q7') ? document.getElementById('survey-q7').value : "",
                q8_horas: document.getElementById('survey-q8') ? document.getElementById('survey-q8').value : "",
                q9_estado: document.getElementById('survey-q9') ? document.getElementById('survey-q9').value : "",
                q13_afectacion: q13Val,
                q16_sentimiento: document.getElementById('survey-q16') ? document.getElementById('survey-q16').value : "",
                q17_aporte: q17Val,
                q18_medidas: q18Checked.join(", "),
                q19_prioridad: document.getElementById('survey-q19') ? document.getElementById('survey-q19').value : "",
                q20_propuesta: document.getElementById('survey-q20') ? document.getElementById('survey-q20').value : ""
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Importante para evitar error CORS con Google Script
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                // Con mode: 'no-cors', la respuesta es opaca, asumimos éxito si no hay error de red
                alert("✅ ¡Datos guardados exitosamente en Google Sheets!");
                btn.innerHTML = originalText;
                lucide.createIcons();
                btn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                alert("❌ Hubo un error al guardar los datos. Revisa la consola o tu conexión.");
                btn.innerHTML = originalText;
                lucide.createIcons();
                btn.disabled = false;
            });
        }

        window.onload = init;
    </script>
</body>
</html>








